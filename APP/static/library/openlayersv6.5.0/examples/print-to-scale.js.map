{"version":3,"sources":["webpack:///./print-to-scale.js"],"names":["defs","const","proj27700","setExtent","raster","fetch","then","response","text","result","read","options","layer","attributions","Date","getFullYear","crossOrigin","projection","wrapX","setSource","map","layers","controls","attributionOptions","collapsible","target","view","center","zoom","scaleLine","bar","minWidth","addControl","dims","a0","a1","a2","a3","a4","a5","exportOptions","filter","element","className","indexOf","exportButton","document","getElementById","addEventListener","disabled","body","style","cursor","format","value","resolution","scale","dim","width","Math","round","height","viewResolution","getView","getResolution","scaleResolution","getProjection","getCenter","once","domtoimage","toJpeg","getViewport","dataUrl","pdf","jsPDF","undefined","addImage","save","setDpi","getTargetElement","updateSize","setResolution"],"mappings":"4FAAA,0FAUA,IAAMA,KACJ,aACA,oKAMF,YAAS,KAETC,IAAMC,EAAY,YAAc,cAChCA,EAAUC,UAAU,CAAC,EAAG,EAAG,IAAQ,OAEnCF,IAAMG,EAAS,IAAI,IAInBC,MADE,sGAECC,MAAK,SAAUC,GACd,OAAOA,EAASC,UAEjBF,MAAK,SAAUE,GACdP,IAAMQ,GAAS,IAAI,KAAmBC,KAAKF,GACrCG,EAAU,YAAwBF,EAAQ,CAC9CG,MAAO,mBAETD,EAAQE,aACN,0DACA,IAAIC,MAAOC,cACbJ,EAAQK,YAAc,GACtBL,EAAQM,WAAaf,EACrBS,EAAQO,OAAQ,EAChBd,EAAOe,UAAU,IAAI,IAAKR,OAG9BV,IAAMmB,EAAM,IAAI,IAAI,CAClBC,OAAQ,CAACjB,GACTkB,SAAU,YAAgB,CACxBC,mBAAoB,CAACC,aAAa,KAEpCC,OAAQ,MACRC,KAAM,IAAI,IAAK,CACbC,OAAQ,CAAC,OAAQ,QACjBV,WAAYf,EACZ0B,KAAM,MAIJC,EAAY,IAAI,IAAU,CAACC,KAAK,EAAMtB,MAAM,EAAMuB,SAAU,MAClEX,EAAIY,WAAWH,GAEf5B,IAAMgC,EAAO,CACXC,GAAI,CAAC,KAAM,KACXC,GAAI,CAAC,IAAK,KACVC,GAAI,CAAC,IAAK,KACVC,GAAI,CAAC,IAAK,KACVC,GAAI,CAAC,IAAK,KACVC,GAAI,CAAC,IAAK,MAKNC,EAAgB,CACpBC,OAAQ,SAAUC,GAChBzC,IAAM0C,EAAYD,EAAQC,WAAa,GACvC,OACuC,IAArCA,EAAUC,QAAQ,eAClBD,EAAUC,QAAQ,aAAe,GAChCD,EAAUC,QAAQ,mBAAqB,GACtCD,EAAUC,QAAQ,sBAKpBC,EAAeC,SAASC,eAAe,cAE7CF,EAAaG,iBACX,SACA,WACEH,EAAaI,UAAW,EACxBH,SAASI,KAAKC,MAAMC,OAAS,WAE7BnD,IAAMoD,EAASP,SAASC,eAAe,UAAUO,MAC3CC,EAAaT,SAASC,eAAe,cAAcO,MACnDE,EAAQV,SAASC,eAAe,SAASO,MACzCG,EAAMxB,EAAKoB,GACXK,EAAQC,KAAKC,MAAOH,EAAI,GAAKF,EAAc,MAC3CM,EAASF,KAAKC,MAAOH,EAAI,GAAKF,EAAc,MAC5CO,EAAiB1C,EAAI2C,UAAUC,gBAC/BC,EACJT,EACA,YACEpC,EAAI2C,UAAUG,gBACdX,EAAa,KACbnC,EAAI2C,UAAUI,aAGlB/C,EAAIgD,KAAK,kBAAkB,WACzB5B,EAAckB,MAAQA,EACtBlB,EAAcqB,OAASA,EACvBQ,WACGC,OAAOlD,EAAImD,cAAe/B,GAC1BlC,MAAK,SAAUkE,GACdvE,IAAMwE,EAAM,IAAIC,MAAM,iBAAaC,EAAWtB,GAC9CoB,EAAIG,SAASJ,EAAS,OAAQ,EAAG,EAAGf,EAAI,GAAIA,EAAI,IAChDgB,EAAII,KAAK,WAEThD,EAAUiD,SACV1D,EAAI2D,mBAAmB5B,MAAMO,MAAQ,GACrCtC,EAAI2D,mBAAmB5B,MAAMU,OAAS,GACtCzC,EAAI4D,aACJ5D,EAAI2C,UAAUkB,cAAcnB,GAC5BjB,EAAaI,UAAW,EACxBH,SAASI,KAAKC,MAAMC,OAAS,aAKnCvB,EAAUiD,OAAOvB,GACjBnC,EAAI2D,mBAAmB5B,MAAMO,MAAQA,EAAQ,KAC7CtC,EAAI2D,mBAAmB5B,MAAMU,OAASA,EAAS,KAC/CzC,EAAI4D,aACJ5D,EAAI2C,UAAUkB,cAAchB,MAE9B,K","file":"print-to-scale.js","sourcesContent":["import Map from '../src/ol/Map.js';\nimport TileLayer from '../src/ol/layer/Tile.js';\nimport View from '../src/ol/View.js';\nimport WMTS, {optionsFromCapabilities} from '../src/ol/source/WMTS.js';\nimport WMTSCapabilities from '../src/ol/format/WMTSCapabilities.js';\nimport proj4 from 'proj4';\nimport {ScaleLine, defaults as defaultControls} from '../src/ol/control.js';\nimport {getPointResolution, get as getProjection} from '../src/ol/proj.js';\nimport {register} from '../src/ol/proj/proj4.js';\n\nproj4.defs(\n  'EPSG:27700',\n  '+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 ' +\n    '+x_0=400000 +y_0=-100000 +ellps=airy ' +\n    '+towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 ' +\n    '+units=m +no_defs'\n);\n\nregister(proj4);\n\nconst proj27700 = getProjection('EPSG:27700');\nproj27700.setExtent([0, 0, 700000, 1300000]);\n\nconst raster = new TileLayer();\n\nconst url =\n  'https://tiles.arcgis.com/tiles/qHLhLQrcvEnxjtPr/arcgis/rest/services/OS_Open_Raster/MapServer/WMTS';\nfetch(url)\n  .then(function (response) {\n    return response.text();\n  })\n  .then(function (text) {\n    const result = new WMTSCapabilities().read(text);\n    const options = optionsFromCapabilities(result, {\n      layer: 'OS_Open_Raster',\n    });\n    options.attributions =\n      'Contains OS data Â© Crown Copyright and database right ' +\n      new Date().getFullYear();\n    options.crossOrigin = '';\n    options.projection = proj27700;\n    options.wrapX = false;\n    raster.setSource(new WMTS(options));\n  });\n\nconst map = new Map({\n  layers: [raster],\n  controls: defaultControls({\n    attributionOptions: {collapsible: false},\n  }),\n  target: 'map',\n  view: new View({\n    center: [373500, 436500],\n    projection: proj27700,\n    zoom: 7,\n  }),\n});\n\nconst scaleLine = new ScaleLine({bar: true, text: true, minWidth: 125});\nmap.addControl(scaleLine);\n\nconst dims = {\n  a0: [1189, 841],\n  a1: [841, 594],\n  a2: [594, 420],\n  a3: [420, 297],\n  a4: [297, 210],\n  a5: [210, 148],\n};\n\n// export options for html-to-image.\n// See: https://github.com/bubkoo/html-to-image#options\nconst exportOptions = {\n  filter: function (element) {\n    const className = element.className || '';\n    return (\n      className.indexOf('ol-control') === -1 ||\n      className.indexOf('ol-scale') > -1 ||\n      (className.indexOf('ol-attribution') > -1 &&\n        className.indexOf('ol-uncollapsible'))\n    );\n  },\n};\n\nconst exportButton = document.getElementById('export-pdf');\n\nexportButton.addEventListener(\n  'click',\n  function () {\n    exportButton.disabled = true;\n    document.body.style.cursor = 'progress';\n\n    const format = document.getElementById('format').value;\n    const resolution = document.getElementById('resolution').value;\n    const scale = document.getElementById('scale').value;\n    const dim = dims[format];\n    const width = Math.round((dim[0] * resolution) / 25.4);\n    const height = Math.round((dim[1] * resolution) / 25.4);\n    const viewResolution = map.getView().getResolution();\n    const scaleResolution =\n      scale /\n      getPointResolution(\n        map.getView().getProjection(),\n        resolution / 25.4,\n        map.getView().getCenter()\n      );\n\n    map.once('rendercomplete', function () {\n      exportOptions.width = width;\n      exportOptions.height = height;\n      domtoimage\n        .toJpeg(map.getViewport(), exportOptions)\n        .then(function (dataUrl) {\n          const pdf = new jsPDF('landscape', undefined, format);\n          pdf.addImage(dataUrl, 'JPEG', 0, 0, dim[0], dim[1]);\n          pdf.save('map.pdf');\n          // Reset original map size\n          scaleLine.setDpi();\n          map.getTargetElement().style.width = '';\n          map.getTargetElement().style.height = '';\n          map.updateSize();\n          map.getView().setResolution(viewResolution);\n          exportButton.disabled = false;\n          document.body.style.cursor = 'auto';\n        });\n    });\n\n    // Set print size\n    scaleLine.setDpi(resolution);\n    map.getTargetElement().style.width = width + 'px';\n    map.getTargetElement().style.height = height + 'px';\n    map.updateSize();\n    map.getView().setResolution(scaleResolution);\n  },\n  false\n);\n"],"sourceRoot":""}